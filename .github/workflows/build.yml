name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: |
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-gc
            mingw-w64-ucrt-x86_64-pcre2
            mingw-w64-ucrt-x86_64-SDL2
            mingw-w64-ucrt-x86_64-SDL2_ttf
            mingw-w64-ucrt-x86_64-libvterm
            libtool
            git
            make
            perl

      - name: Setup environment
        shell: msys2 {0}
        run: |
          # Set up environment variables for all subsequent steps
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          echo "WORKSPACE=$WORKSPACE" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig" >> $GITHUB_ENV

      - name: Install rlottie from source
        shell: msys2 {0}
        continue-on-error: true
        run: |
          cd "$WORKSPACE"
          echo "Working directory: $(pwd)"
          echo "Checking build tools..."
          g++ --version || echo "Warning: g++ not found"
          cmake --version
          ninja --version
          echo "Installing rlottie..."
          bash scripts/install-rlottie.sh --prefix /usr/local 2>&1 | tee rlottie-install.log || {
            echo "=== rlottie installation failed ==="
            echo "Last 100 lines of log:"
            tail -100 rlottie-install.log || true
            echo "Continuing without rlottie (optional dependency)"
            exit 0
          }
          echo "rlottie installed successfully"

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          cd "$WORKSPACE"
          mkdir -p build
          cd build
          cmake .. -G Ninja

      - name: Build
        shell: msys2 {0}
        run: |
          cd "$WORKSPACE/build"
          cmake --build . --config Release

      - name: Test
        shell: msys2 {0}
        run: |
          cd "$WORKSPACE/build"
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-windows
          path: |
            build/telnet-gui.exe
            build/*.dll
            build/librlottie.dll
          retention-days: 7

  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libgc-dev \
            libpcre2-dev \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libvterm-dev \
            librlottie-dev \
            git \
            make \
            libtool \
            perl

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja

      - name: Build
        run: |
          cd build
          cmake --build . --config Release

      - name: Test
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-linux
          path: build/telnet-gui
          retention-days: 7

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew update
          # List of required packages
          PACKAGES="cmake ninja pkg-config bdw-gc pcre2 sdl2 sdl2_ttf libvterm pixman git libtool"

          # Check which packages are already installed
          INSTALLED=$(brew list --formula 2>/dev/null || true)
          TO_INSTALL=""

          for pkg in $PACKAGES; do
            # pkg-config is an alias for pkgconf in Homebrew, check for both
            if [ "$pkg" = "pkg-config" ]; then
              if echo "$INSTALLED" | grep -qE "^(pkg-config|pkgconf)$"; then
                echo "✓ $pkg is already installed (as pkgconf)"
                continue
              fi
            fi

            if echo "$INSTALLED" | grep -q "^${pkg}$"; then
              echo "✓ $pkg is already installed"
            else
              TO_INSTALL="$TO_INSTALL $pkg"
            fi
          done

          # Only install missing packages
          if [ -n "$TO_INSTALL" ]; then
            echo "Installing missing packages:$TO_INSTALL"
            brew install $TO_INSTALL
          else
            echo "All required packages are already installed"
          fi

      - name: Setup environment
        run: |
          # Detect Homebrew prefix (Apple Silicon uses /opt/homebrew, Intel uses /usr/local)
          if [ -d "/opt/homebrew" ]; then
            echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
          else
            echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
          fi
          echo "RLOTTIE_PREFIX=${{ github.workspace }}/rlottie-install" >> $GITHUB_ENV

      - name: Install rlottie from source
        continue-on-error: true
        run: |
          echo "Installing rlottie to: $RLOTTIE_PREFIX"
          echo "Checking build tools..."
          g++ --version || echo "Warning: g++ not found"
          clang++ --version || echo "Warning: clang++ not found"
          cmake --version
          ninja --version

          echo "=== Installing rlottie from source ==="
          set +e  # Don't exit on error, we'll check exit code
          bash scripts/install-rlottie.sh --prefix "$RLOTTIE_PREFIX" 2>&1 | tee rlottie-install.log
          RLOTTIE_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if [ $RLOTTIE_EXIT_CODE -ne 0 ]; then
            echo "=== rlottie installation failed with exit code $RLOTTIE_EXIT_CODE ==="
            echo "Last 100 lines of log:"
            tail -100 rlottie-install.log || true
            echo "Continuing without rlottie (optional dependency)"
            exit 0
          fi

          echo "=== Verifying rlottie installation ==="
          if [ -f "$RLOTTIE_PREFIX/include/rlottiecommon.h" ] && \
             [ -f "$RLOTTIE_PREFIX/lib/pkgconfig/rlottie.pc" ]; then
            echo "✓ rlottie installed successfully"
          else
            echo "⚠ Warning: rlottie installation may be incomplete"
          fi

      - name: Configure CMake
        run: |
          # Build PKG_CONFIG_PATH with rlottie if it exists
          PKG_CONFIG_PATHS="$HOMEBREW_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig"
          CMAKE_PREFIX_PATHS="$HOMEBREW_PREFIX:/usr/local"
          if [ -d "$RLOTTIE_PREFIX/lib/pkgconfig" ]; then
            PKG_CONFIG_PATHS="$RLOTTIE_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATHS"
            CMAKE_PREFIX_PATHS="$RLOTTIE_PREFIX:$CMAKE_PREFIX_PATHS"
            echo "Including rlottie from: $RLOTTIE_PREFIX"
          fi
          export PKG_CONFIG_PATH="$PKG_CONFIG_PATHS"

          # Verify pkg-config can find bdw-gc
          pkg-config --modversion bdw-gc || echo "Warning: pkg-config cannot find bdw-gc"
          mkdir -p build
          cd build
          cmake .. -G Ninja -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATHS"

      - name: Build
        run: |
          PKG_CONFIG_PATHS="$HOMEBREW_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig"
          [ -d "$RLOTTIE_PREFIX/lib/pkgconfig" ] && PKG_CONFIG_PATHS="$RLOTTIE_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATHS"
          export PKG_CONFIG_PATH="$PKG_CONFIG_PATHS"
          cd build
          cmake --build . --config Release

      - name: Test
        run: |
          PKG_CONFIG_PATHS="$HOMEBREW_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig"
          [ -d "$RLOTTIE_PREFIX/lib/pkgconfig" ] && PKG_CONFIG_PATHS="$RLOTTIE_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATHS"
          export PKG_CONFIG_PATH="$PKG_CONFIG_PATHS"
          cd build
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-macos
          path: build/telnet-gui
          retention-days: 7
