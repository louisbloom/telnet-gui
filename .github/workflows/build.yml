name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: |
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-gc
            mingw-w64-ucrt-x86_64-pcre2
            mingw-w64-ucrt-x86_64-SDL2
            mingw-w64-ucrt-x86_64-SDL2_ttf
            mingw-w64-ucrt-x86_64-libvterm
            libtool
            git
            make
            perl

      - name: Install rlottie from source
        shell: msys2 {0}
        continue-on-error: true
        run: |
          # Convert Windows path to MSYS2 path using cygpath
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          cd "$WORKSPACE"
          echo "Working directory: $(pwd)"
          echo "Checking build tools..."
          g++ --version || echo "Warning: g++ not found"
          cmake --version
          ninja --version
          echo "Installing rlottie..."
          bash scripts/install-rlottie.sh --prefix /usr/local 2>&1 | tee rlottie-install.log || {
            echo "=== rlottie installation failed ==="
            echo "Last 100 lines of log:"
            tail -100 rlottie-install.log || true
            echo "Continuing without rlottie (optional dependency)"
            exit 0
          }
          echo "rlottie installed successfully"
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig:$PKG_CONFIG_PATH

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          # Convert Windows path to MSYS2 path using cygpath
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          cd "$WORKSPACE"
          mkdir -p build
          cd build
          cmake .. -G Ninja
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig:$PKG_CONFIG_PATH

      - name: Build
        shell: msys2 {0}
        run: |
          # Convert Windows path to MSYS2 path using cygpath
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          cd "$WORKSPACE/build"
          cmake --build . --config Release
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig:$PKG_CONFIG_PATH

      - name: Test
        shell: msys2 {0}
        run: |
          # Convert Windows path to MSYS2 path using cygpath
          WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          cd "$WORKSPACE/build"
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-windows
          path: |
            build/telnet-gui.exe
            build/*.dll
            build/librlottie.dll
          retention-days: 7

  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libgc-dev \
            libpcre2-dev \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libvterm-dev \
            librlottie-dev \
            git \
            make \
            libtool \
            perl

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja

      - name: Build
        run: |
          cd build
          cmake --build . --config Release

      - name: Test
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-linux
          path: build/telnet-gui
          retention-days: 7

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew update
          brew install \
            cmake \
            ninja \
            pkg-config \
            bdw-gc \
            pcre2 \
            sdl2 \
            sdl2_ttf \
            libvterm \
            git \
            libtool

      - name: Install rlottie from source
        continue-on-error: true
        run: |
          # Detect Homebrew prefix (Apple Silicon uses /opt/homebrew, Intel uses /usr/local)
          if [ -d "/opt/homebrew" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi
          export HOMEBREW_PREFIX
          echo "Homebrew prefix: $HOMEBREW_PREFIX"
          echo "Installing rlottie to: $HOMEBREW_PREFIX"
          
          echo "Checking build tools..."
          g++ --version || echo "Warning: g++ not found"
          clang++ --version || echo "Warning: clang++ not found"
          cmake --version
          ninja --version
          
          echo "=== Installing rlottie from source ==="
          set +e  # Don't exit on error, we'll check exit code
          bash scripts/install-rlottie.sh --prefix "$HOMEBREW_PREFIX" 2>&1 | tee rlottie-install.log
          RLOTTIE_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $RLOTTIE_EXIT_CODE -ne 0 ]; then
            echo "=== rlottie installation failed with exit code $RLOTTIE_EXIT_CODE ==="
            echo "Last 100 lines of log:"
            tail -100 rlottie-install.log || true
            echo ""
            echo "Checking if rlottie files exist:"
            ls -la "$HOMEBREW_PREFIX/include/rlottie"* 2>/dev/null || echo "  No rlottie headers found"
            ls -la "$HOMEBREW_PREFIX/lib/librlottie"* 2>/dev/null || echo "  No rlottie libraries found"
            ls -la "$HOMEBREW_PREFIX/lib/pkgconfig/rlottie.pc" 2>/dev/null || echo "  No rlottie.pc found"
            echo ""
            echo "Continuing without rlottie (optional dependency)"
            exit 0
          fi
          
          echo "=== Verifying rlottie installation ==="
          if [ -f "$HOMEBREW_PREFIX/include/rlottiecommon.h" ] && \
             [ -f "$HOMEBREW_PREFIX/lib/pkgconfig/rlottie.pc" ]; then
            echo "✓ rlottie installed successfully"
            echo "  Headers: $HOMEBREW_PREFIX/include/rlottie*.h"
            echo "  pkg-config: $HOMEBREW_PREFIX/lib/pkgconfig/rlottie.pc"
          else
            echo "⚠ Warning: rlottie installation may be incomplete"
            echo "  Checking for files:"
            ls -la "$HOMEBREW_PREFIX/include/rlottie"* 2>/dev/null || echo "    No headers found"
            ls -la "$HOMEBREW_PREFIX/lib/pkgconfig/rlottie.pc" 2>/dev/null || echo "    No pkg-config file found"
          fi

      - name: Configure CMake
        run: |
          # Detect Homebrew prefix (Apple Silicon uses /opt/homebrew, Intel uses /usr/local)
          if [ -d "/opt/homebrew" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi
          export HOMEBREW_PREFIX
          echo "Homebrew prefix: $HOMEBREW_PREFIX"
          # Set PKG_CONFIG_PATH to include Homebrew paths
          export PKG_CONFIG_PATH="$HOMEBREW_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
          # Verify pkg-config can find bdw-gc
          pkg-config --modversion bdw-gc || echo "Warning: pkg-config cannot find bdw-gc"
          pkg-config --cflags bdw-gc || echo "Warning: pkg-config cannot get cflags for bdw-gc"
          mkdir -p build
          cd build
          cmake .. -G Ninja \
            -DCMAKE_PREFIX_PATH="$HOMEBREW_PREFIX:/usr/local"

      - name: Build
        run: |
          # Detect Homebrew prefix (same as Configure step)
          if [ -d "/opt/homebrew" ]; then
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            HOMEBREW_PREFIX="/usr/local"
          fi
          export PKG_CONFIG_PATH="$HOMEBREW_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
          cd build
          cmake --build . --config Release

      - name: Test
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: telnet-gui-macos
          path: build/telnet-gui
          retention-days: 7
